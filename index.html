<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>A Level Ancient History - Multiple Choice Quizzes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Shared styles with Revision Randomiser -->
    <link rel="stylesheet" href="styles.css" />

    <style>
        /* =========================================
           MCQ-specific styling (uses shared theme vars)
           ========================================= */

        .card-panel-mcq {
            width: 100%;
            max-width: 880px;
            background-color: var(--bg-elevated);
            border-radius: 22px;
            padding: 20px 20px 22px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        body.theme-light .card-panel-mcq {
            background-color: var(--bg-card);
        }

        .mcq-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .mcq-title {
            margin: 0 0 4px;
            font-size: 18px;
            font-weight: 600;
        }

        .mcq-subtitle {
            margin: 0;
            font-size: 13px;
            color: var(--text-soft);
        }

        .mcq-pill {
            font-size: 12px;
            border-radius: 999px;
            padding: 4px 10px;
            background-color: var(--accent-soft);
            border: 1px solid var(--border-subtle);
            color: var(--text-soft);
            white-space: nowrap;
        }

        .mcq-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 2px;
        }

        .toggle-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 9px;
            border-radius: 999px;
            background-color: var(--bg-elevated-soft);
            border: 1px solid var(--border-subtle);
            font-size: 12px;
            color: var(--text-soft);
            cursor: pointer;
        }

        .toggle-chip input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: var(--accent);
        }

        .toggle-label {
            user-select: none;
        }

        .breadcrumbs {
            font-size: 12px;
            color: var(--text-soft);
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        .breadcrumbs span[data-level] {
            cursor: pointer;
            padding: 2px 7px;
            border-radius: 999px;
            background-color: var(--bg-elevated-soft);
            border: 1px solid transparent;
        }
        .breadcrumbs span[data-level]:hover {
            border-color: var(--accent);
            color: var(--accent-strong);
        }
        .breadcrumbs span:last-child:not([data-level]) {
            font-weight: 500;
            color: var(--text);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background-color: var(--bg-elevated-soft);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            display: none;
        }
        .progress-fill {
            height: 100%;
            width: 0;
            background-color: var(--accent);
            transition: width 0.25s ease-out;
        }

        /* Lists for modules / units / quizzes */

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 6px;
            margin-bottom: 10px;
        }

        .list-item {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid var(--list-border);
            background: var(--list-bg);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition:
                background-color 0.18s ease,
                border-color 0.18s ease,
                box-shadow 0.18s ease,
                transform 0.08s ease;
        }
        .list-item:hover {
            background: var(--list-bg-hover);
            border-color: var(--accent);
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.35);
            transform: translateY(-1px);
        }

        .list-title {
            font-size: 15px;
            font-weight: 600;
        }

        .list-meta {
            font-size: 12px;
            color: var(--text-soft);
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .helper-text {
            font-size: 12px;
            color: var(--text-soft);
        }

        .error-text {
            font-size: 13px;
            color: var(--danger);
        }

        /* Question view */

        .question-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .question-meta {
            margin: 0 0 10px;
            font-size: 13px;
            color: var(--text-soft);
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .option-btn {
            width: 100%;
            text-align: left;
            padding: 9px 11px;
            border-radius: 14px;
            border: 1px solid var(--option-border);
            background: var(--option-bg);
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            transition:
                background-color 0.18s ease,
                border-color 0.18s ease,
                box-shadow 0.18s ease,
                transform 0.08s ease;
        }
        .option-btn:hover {
            background: var(--option-bg-hover);
            border-color: var(--accent);
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.35);
            transform: translateY(-1px);
        }
        .option-btn.selected {
            border-color: var(--accent-strong);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.45);
        }
        .option-btn.correct {
            border-color: var(--success);
        }
        .option-btn.incorrect {
            border-color: var(--danger);
        }

        .option-label {
            font-weight: 600;
            min-width: 20px;
        }

        .option-text {
            flex: 1;
        }

        .feedback {
            min-height: 20px;
            font-size: 13px;
            color: var(--text-soft);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        .feedback.correct span {
            color: var(--success);
        }
        .feedback.incorrect span {
            color: var(--danger);
        }

        .controls {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Results */

        .result-heading {
            font-size: 17px;
            font-weight: 600;
            margin: 0 0 4px;
        }
        .result-score {
            font-size: 14px;
            margin: 0 0 6px;
        }
        .result-detail {
            font-size: 13px;
            margin: 0 0 8px;
            color: var(--text-soft);
        }

        .summary-list {
            margin-top: 8px;
            border-top: 1px solid var(--border-subtle);
            padding-top: 8px;
            max-height: 260px;
            overflow-y: auto;
        }
        .summary-item {
            font-size: 13px;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border-subtle);
        }
        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-question {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .summary-answer {
            margin: 1px 0;
        }
        .summary-answer span.label {
            font-weight: 500;
        }
        .summary-answer.correct span.value {
            color: var(--success);
        }
        .summary-answer.incorrect span.value {
            color: var(--danger);
        }

        @media (max-width: 768px) {
            .card-panel-mcq {
                padding: 16px 14px 18px;
                border-radius: 18px;
            }
            .mcq-header-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }
    </style>
</head>
<body class="theme-light">
    <div class="app-shell">
        <!-- Shared header: matches Revision Randomiser -->
        <header class="app-header">
            <div class="header-left">
                <div class="app-logo-circle">Q</div>
                <div class="app-title-group">
                    <h1 class="app-title">Ancient History MCQs</h1>
                    <p class="app-subtitle">Multiple-choice quizzes for active recall</p>
                </div>
            </div>
            <div class="header-right">
                <button
                    id="toggleThemeBtn"
                    class="icon-button"
                    type="button"
                    aria-label="Toggle theme"
                    title="Toggle light / dark theme"
                >
                    ðŸŒ—
                </button>
                <!-- Optional link back to the main Revision Randomiser app -->
                <a
                    href="#"
                    class="icon-button"
                    title="Open Revision Randomiser"
                >
                    RR
                </a>
            </div>
        </header>

        <!-- Main content area -->
        <main class="app-main">
            <section class="card-panel-mcq">
                <div class="mcq-header-row">
                    <div>
                        <h2 class="mcq-title" id="card-title">
                            A Level Ancient History â€“ Multiple Choice Quizzes
                        </h2>
                        <p class="mcq-subtitle">
                            Browse modules and units, then take topic-specific MCQ quizzes.
                        </p>
                    </div>
                    <div class="mcq-pill" id="pill-right"></div>
                </div>

                <!-- New toggles -->
                <div class="mcq-toggles">
                    <label class="toggle-chip">
                        <input type="checkbox" id="toggle-shuffle" />
                        <span class="toggle-label">Shuffle question order</span>
                    </label>
                    <label class="toggle-chip">
                        <input type="checkbox" id="toggle-hide-feedback" />
                        <span class="toggle-label">Hide correct answers until the end</span>
                    </label>
                </div>

                <div class="breadcrumbs" id="breadcrumbs"></div>

                <div class="progress-bar" id="progress-container">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <div id="quiz-content">
                    <!-- Dynamic content injected by JS -->
                </div>
            </section>
        </main>
    </div>

    <script>
        // ================================
        // Theme toggle (shared behaviour)
        // ================================

        const THEME_KEY = "revision-theme";

        function applyStoredTheme() {
            const stored = localStorage.getItem(THEME_KEY);
            if (!stored || stored === "light") {
                document.body.classList.add("theme-light");
            } else {
                document.body.classList.remove("theme-light");
            }
        }

        function toggleTheme() {
            const isLight = document.body.classList.contains("theme-light");
            if (isLight) {
                document.body.classList.remove("theme-light");
                localStorage.setItem(THEME_KEY, "dark");
            } else {
                document.body.classList.add("theme-light");
                localStorage.setItem(THEME_KEY, "light");
            }
        }

        applyStoredTheme();

        const themeBtn = document.getElementById("toggleThemeBtn");
        if (themeBtn) {
            themeBtn.addEventListener("click", toggleTheme);
        }

        // ================================
        // MCQ APP LOGIC (with new toggles)
        // ================================

        let modules = [];
        let currentModule = null;
        let currentUnit = null;
        let currentQuizMeta = null;
        let currentQuizData = null;

        let currentQuestionIndex = 0; // position in order (0..n-1)
        let selectedOptionIndex = null;
        let score = 0;
        const answers = [];

        // New state for toggles
        let shuffleQuestionsEnabled = false;
        let hideFeedbackEnabled = false;
        let questionOrder = []; // array of original question indices

        const quizContentEl = document.getElementById("quiz-content");
        const cardTitleEl = document.getElementById("card-title");
        const pillRightEl = document.getElementById("pill-right");
        const progressContainerEl = document.getElementById("progress-container");
        const progressFillEl = document.getElementById("progress-fill");
        const breadcrumbsEl = document.getElementById("breadcrumbs");

        // Shuffle helper (Fisherâ€“Yates)
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        async function loadModules() {
            try {
                const res = await fetch("modules.json");
                if (!res.ok) throw new Error("Failed to load modules.json");
                modules = await res.json();
                renderModuleList();
            } catch (err) {
                console.error(err);
                pillRightEl.textContent = "Error loading modules";
                progressContainerEl.style.display = "none";
                breadcrumbsEl.textContent = "";
                quizContentEl.innerHTML = `
          <p class="error-text">Could not load <code>modules.json</code>.</p>
          <p class="helper-text">
            Make sure <strong>modules.json</strong> is in the same folder as
            <strong>index.html</strong> and that you're running this via a local web
            server (not opening the file directly).
          </p>
        `;
            }
        }

        function setBreadcrumbs(level) {
            const bits = [];
            bits.push(`<span data-level="modules">Modules</span>`);

            if (currentModule && level !== "modules") {
                bits.push("â€º");
                bits.push(`<span data-level="units">${currentModule.name}</span>`);
            }
            if (currentUnit && (level === "quizzes" || level === "quiz")) {
                bits.push("â€º");
                bits.push(`<span data-level="quizzes">${currentUnit.name}</span>`);
            }
            if (currentQuizMeta && level === "quiz") {
                bits.push("â€º");
                bits.push(`<span>${currentQuizMeta.title}</span>`);
            }

            breadcrumbsEl.innerHTML = bits.join(" ");

            Array.from(
                breadcrumbsEl.querySelectorAll("span[data-level]")
            ).forEach((el) => {
                el.addEventListener("click", () => {
                    const lvl = el.getAttribute("data-level");
                    if (lvl === "modules") {
                        renderModuleList();
                    } else if (lvl === "units") {
                        renderUnitList(currentModule.id);
                    } else if (lvl === "quizzes") {
                        renderQuizList(currentUnit.id);
                    }
                });
            });
        }

        function renderModuleList() {
            currentModule = null;
            currentUnit = null;
            currentQuizMeta = null;
            currentQuizData = null;
            questionOrder = [];

            cardTitleEl.textContent =
                "A Level Ancient History â€“ Multiple Choice Quizzes";
            progressContainerEl.style.display = "none";
            progressFillEl.style.width = "0";
            setBreadcrumbs("modules");

            if (!modules || !modules.length) {
                pillRightEl.textContent = "0 modules";
                quizContentEl.innerHTML = `
          <p>No modules found in <code>modules.json</code>.</p>
          <p class="helper-text">
            Add modules, units and quizzes to the JSON file to see them listed here.
          </p>
        `;
                return;
            }

            pillRightEl.textContent =
                modules.length === 1 ? "1 module" : `${modules.length} modules`;

            const html = `
        <div class="list">
          ${modules
              .map(
                  (m) => `
            <button class="list-item" data-id="${m.id}">
              <div class="list-title">${m.name}</div>
              <div class="list-meta">
                <span>${m.units?.length || 0} unit${
                      (m.units?.length || 0) !== 1 ? "s" : ""
                  }</span>
                ${m.description ? `<span>â€¢ ${m.description}</span>` : ""}
              </div>
            </button>
          `
              )
              .join("")}
        </div>
        <p class="helper-text">
          Select a module to view its units and quizzes. Edit
          <strong>modules.json</strong> to organise your content.
        </p>
      `;

            quizContentEl.innerHTML = html;

            document.querySelectorAll(".list-item").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-id");
                    renderUnitList(id);
                });
            });
        }

        function renderUnitList(moduleId) {
            const mod = modules.find((m) => m.id === moduleId);
            if (!mod) return;

            currentModule = mod;
            currentUnit = null;
            currentQuizMeta = null;
            currentQuizData = null;
            questionOrder = [];

            cardTitleEl.textContent = mod.name;
            progressContainerEl.style.display = "none";
            progressFillEl.style.width = "0";
            setBreadcrumbs("units");

            const units = mod.units || [];
            pillRightEl.textContent =
                units.length === 1 ? "1 unit" : `${units.length} units`;

            if (!units.length) {
                quizContentEl.innerHTML = `
          <p>No units found for this module.</p>
          <div class="controls">
            <button class="secondary-button" id="back-modules">Back to modules</button>
          </div>
        `;
                document
                    .getElementById("back-modules")
                    .addEventListener("click", () => renderModuleList());
                return;
            }

            const html = `
        <div class="list">
          ${units
              .map(
                  (u) => `
            <button class="list-item" data-id="${u.id}">
              <div class="list-title">${u.name}</div>
              <div class="list-meta">
                <span>${u.quizzes?.length || 0} quiz${
                      (u.quizzes?.length || 0) !== 1 ? "zes" : ""
                  }</span>
                ${u.description ? `<span>â€¢ ${u.description}</span>` : ""}
              </div>
            </button>
          `
              )
              .join("")}
        </div>
        <div class="controls" style="justify-content:flex-start;">
          <button class="secondary-button" id="back-modules">Back to modules</button>
        </div>
      `;

            quizContentEl.innerHTML = html;

            document.querySelectorAll(".list-item").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-id");
                    renderQuizList(id);
                });
            });

            document
                .getElementById("back-modules")
                .addEventListener("click", () => renderModuleList());
        }

        function renderQuizList(unitId) {
            if (!currentModule) return;
            const unit = (currentModule.units || []).find((u) => u.id === unitId);
            if (!unit) return;

            currentUnit = unit;
            currentQuizMeta = null;
            currentQuizData = null;
            questionOrder = [];

            cardTitleEl.textContent = unit.name;
            progressContainerEl.style.display = "none";
            progressFillEl.style.width = "0";
            setBreadcrumbs("quizzes");

            const quizzes = unit.quizzes || [];
            pillRightEl.textContent =
                quizzes.length === 1 ? "1 quiz" : `${quizzes.length} quizzes`;

            if (!quizzes.length) {
                quizContentEl.innerHTML = `
          <p>No quizzes found for this unit.</p>
          <div class="controls" style="justify-content:flex-start;">
            <button class="secondary-button" id="back-units">Back to units</button>
          </div>
        `;
                document
                    .getElementById("back-units")
                    .addEventListener("click", () => renderUnitList(currentModule.id));
                return;
            }

            const html = `
        <div class="list">
          ${quizzes
              .map(
                  (q) => `
            <button class="list-item" data-id="${q.id}">
              <div class="list-title">${q.title}</div>
              <div class="list-meta">
                <span>Quiz file: ${q.path}</span>
              </div>
            </button>
          `
              )
              .join("")}
        </div>
        <div class="controls" style="justify-content:flex-start%;">
          <button class="secondary-button" id="back-units">Back to units</button>
        </div>
      `;

            quizContentEl.innerHTML = html;

            document.querySelectorAll(".list-item").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-id");
                    const meta = quizzes.find((q) => q.id === id);
                    if (meta) startQuiz(meta);
                });
            });

            document
                .getElementById("back-units")
                .addEventListener("click", () => renderUnitList(currentModule.id));
        }

        async function startQuiz(quizMeta) {
            currentQuizMeta = quizMeta;
            currentQuizData = null;
            currentQuestionIndex = 0;
            selectedOptionIndex = null;
            score = 0;
            answers.length = 0;
            questionOrder = [];

            setBreadcrumbs("quiz");
            pillRightEl.textContent = "Loading quizâ€¦";
            progressContainerEl.style.display = "none";
            progressFillEl.style.width = "0";

            quizContentEl.innerHTML = `
        <p>Loading quiz <strong>${quizMeta.title}</strong>â€¦</p>
        <p class="helper-text">File: <code>${quizMeta.path}</code></p>
      `;

            try {
                const res = await fetch(quizMeta.path);
                if (!res.ok) throw new Error("Failed to load quiz JSON");
                const data = await res.json();
                currentQuizData = data;

                const questions = currentQuizData.questions || [];
                questionOrder = questions.map((_, i) => i);
                if (shuffleQuestionsEnabled) {
                    shuffleArray(questionOrder);
                }

                cardTitleEl.textContent = data.title || quizMeta.title;
                progressContainerEl.style.display = "block";
                renderQuestion();
            } catch (err) {
                console.error(err);
                pillRightEl.textContent = "Error loading quiz";
                progressContainerEl.style.display = "none";
                quizContentEl.innerHTML = `
          <p class="error-text">Could not load quiz file <code>${quizMeta.path}</code>.</p>
          <div class="controls" style="justify-content:flex-start;">
            <button class="secondary-button" id="back-quizzes">Back to quizzes</button>
          </div>
        `;
                document
                    .getElementById("back-quizzes")
                    .addEventListener("click", () => renderQuizList(currentUnit.id));
            }
        }

        function renderQuestion() {
            const questions = currentQuizData.questions || [];
            const orderIndex = questionOrder[currentQuestionIndex] ?? currentQuestionIndex;
            const q = questions[orderIndex];
            if (!q) return;

            selectedOptionIndex = null;

            setBreadcrumbs("quiz");
            pillRightEl.textContent = `Question ${
                currentQuestionIndex + 1
            } of ${questions.length}`;
            const progressPercent = (currentQuestionIndex / questions.length) * 100;
            progressFillEl.style.width = `${progressPercent}%`;

            const optionLetters = ["A", "B", "C", "D", "E", "F", "G", "H"];
            const optionsHtml = q.options
                .map(
                    (opt, i) => `
          <button class="option-btn" data-index="${i}">
            <span class="option-label">${optionLetters[i] ?? ""}.</span>
            <span class="option-text">${opt}</span>
          </button>
        `
                )
                .join("");

            quizContentEl.innerHTML = `
        <div class="question-text">${q.question}</div>
        <p class="question-meta">${
            currentQuizData.description || "Choose one answer."
        }</p>
        <div class="options">
          ${optionsHtml}
        </div>
        <div class="feedback" id="feedback"></div>
        <div class="controls">
          <button class="secondary-button" id="back-to-quizzes">Back to quizzes</button>
          <button class="secondary-button" id="skip-btn">Skip</button>
          <button class="primary-button" id="next-btn" disabled>
            Next â†’
          </button>
        </div>
      `;

            document
                .querySelectorAll(".option-btn")
                .forEach((btn) => btn.addEventListener("click", onOptionClick));
            document.getElementById("next-btn").addEventListener("click", onNext);
            document.getElementById("skip-btn").addEventListener("click", onSkip);
            document
                .getElementById("back-to-quizzes")
                .addEventListener("click", () => renderQuizList(currentUnit.id));
        }

        function onOptionClick(e) {
            const btn = e.currentTarget;
            const index = Number(btn.getAttribute("data-index"));
            selectedOptionIndex = index;

            document.querySelectorAll(".option-btn").forEach((b) => {
                b.classList.remove("selected");
            });
            btn.classList.add("selected");

            document.getElementById("next-btn").disabled = false;
            const feedbackEl = document.getElementById("feedback");
            feedbackEl.textContent = "Answer selected.";
            feedbackEl.className = "feedback";
        }

        function lockOptionsAndShowFeedback(isCorrect, correctIndex) {
            const feedbackEl = document.getElementById("feedback");
            feedbackEl.className =
                "feedback " + (isCorrect ? "correct" : "incorrect");

            document.querySelectorAll(".option-btn").forEach((btn) => {
                const idx = Number(btn.getAttribute("data-index"));
                btn.disabled = true;
                btn.classList.remove("selected");

                if (idx === correctIndex) {
                    btn.classList.add("correct");
                } else if (idx === selectedOptionIndex && !isCorrect) {
                    btn.classList.add("incorrect");
                }
            });

            if (isCorrect) {
                feedbackEl.innerHTML = `<span>Correct!</span> Nice job.`;
            } else if (selectedOptionIndex === null) {
                feedbackEl.innerHTML = `<span>Skipped.</span> The correct answer is highlighted.`;
            } else {
                feedbackEl.innerHTML = `<span>Incorrect.</span> The correct answer is highlighted.`;
            }
        }

        function onNext() {
            const questions = currentQuizData.questions;
            const orderIndex = questionOrder[currentQuestionIndex] ?? currentQuestionIndex;
            const q = questions[orderIndex];
            const correctIndex = q.correctIndex;
            const isCorrect = selectedOptionIndex === correctIndex;

            if (selectedOptionIndex !== null && isCorrect) {
                score++;
            }

            answers.push({
                questionIndex: orderIndex,
                selected: selectedOptionIndex,
                correctIndex,
                isCorrect,
            });

            if (hideFeedbackEnabled) {
                // No per-question feedback: move straight on
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion();
                } else {
                    renderResult();
                }
            } else {
                // Show feedback & highlight correct/incorrect before moving on
                lockOptionsAndShowFeedback(isCorrect, correctIndex);
                setTimeout(() => {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < questions.length) {
                        renderQuestion();
                    } else {
                        renderResult();
                    }
                }, 650);
            }
        }

        function onSkip() {
            const questions = currentQuizData.questions;
            const orderIndex = questionOrder[currentQuestionIndex] ?? currentQuestionIndex;
            const q = questions[orderIndex];
            const correctIndex = q.correctIndex;

            answers.push({
                questionIndex: orderIndex,
                selected: null,
                correctIndex,
                isCorrect: false,
            });

            if (hideFeedbackEnabled) {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion();
                } else {
                    renderResult();
                }
            } else {
                lockOptionsAndShowFeedback(false, correctIndex);
                setTimeout(() => {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < questions.length) {
                        renderQuestion();
                    } else {
                        renderResult();
                    }
                }, 650);
            }
        }

        function renderResult() {
            const questions = currentQuizData.questions;
            const total = questions.length;
            const percent = Math.round((score / total) * 100);

            progressFillEl.style.width = "100%";
            pillRightEl.textContent = "Quiz complete";
            setBreadcrumbs("quiz");

            const summaryItemsHtml = answers
                .map((ans, i) => {
                    const q = questions[ans.questionIndex];
                    const qNumber = i + 1;
                    const userAnswerText =
                        ans.selected === null ? "No answer" : q.options[ans.selected];
                    const correctAnswerText = q.options[ans.correctIndex];
                    const userClass = ans.isCorrect ? "correct" : "incorrect";

                    return `
            <div class="summary-item">
              <div class="summary-question">
                ${qNumber}. ${q.question}
              </div>
              <div class="summary-answer ${userClass}">
                <span class="label">Your answer:</span>
                <span class="value"> ${userAnswerText}</span>
              </div>
              <div class="summary-answer">
                <span class="label">Correct answer:</span>
                <span class="value"> ${correctAnswerText}</span>
              </div>
            </div>
          `;
                })
                .join("");

            quizContentEl.innerHTML = `
        <div class="result-heading">
          Your results for "${currentQuizData.title || currentQuizMeta.title}"
        </div>
        <p class="result-score">
          You scored <strong>${score}</strong> out of <strong>${total}</strong> (${percent}%)
        </p>
        <p class="result-detail">
          Review your answers below, or go back to choose another quiz in this unit.
        </p>

        <div class="controls" style="margin-bottom: 6px;">
          <button class="secondary-button" id="back-quizzes">Back to quizzes</button>
          <button class="primary-button" id="restart-btn">Retake this quiz</button>
        </div>

        <div class="summary-list">
          ${summaryItemsHtml}
        </div>
      `;

            document.getElementById("restart-btn").addEventListener("click", () => {
                startQuiz(currentQuizMeta);
            });

            document
                .getElementById("back-quizzes")
                .addEventListener("click", () => {
                    renderQuizList(currentUnit.id);
                });
        }

        // Hook up the new toggle controls
        const shuffleToggleEl = document.getElementById("toggle-shuffle");
        const hideFeedbackToggleEl = document.getElementById("toggle-hide-feedback");

        if (shuffleToggleEl) {
            shuffleToggleEl.addEventListener("change", (e) => {
                shuffleQuestionsEnabled = e.target.checked;
            });
        }

        if (hideFeedbackToggleEl) {
            hideFeedbackToggleEl.addEventListener("change", (e) => {
                hideFeedbackEnabled = e.target.checked;
            });
        }

        loadModules();
    </script>
</body>
</html>
