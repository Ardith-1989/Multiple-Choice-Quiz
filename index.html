<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>A Level Ancient History - Multiple Choice Quizzes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Shared styles with Revision Randomiser -->
    <link rel="stylesheet" href="styles.css" />

    <style>
        /* =========================================
           MCQ-specific styling (uses shared theme vars)
           ========================================= */

        .card-panel-mcq {
            width: 100%;
            max-width: 880px;
            background-color: var(--bg-elevated);
            border-radius: 22px;
            padding: 20px 20px 22px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        body.theme-light .card-panel-mcq {
            background-color: var(--bg-card);
        }

        .mcq-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .mcq-title {
            margin: 0 0 4px;
            font-size: 18px;
            font-weight: 600;
        }

        .mcq-subtitle {
            margin: 0;
            font-size: 13px;
            color: var(--text-soft);
        }

        .mcq-pill {
            font-size: 12px;
            border-radius: 999px;
            padding: 4px 10px;
            background-color: var(--accent-soft);
            border: 1px solid var(--border-subtle);
            color: var(--text-soft);
            white-space: nowrap;
        }

        .breadcrumbs {
            font-size: 12px;
            color: var(--text-soft);
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        .breadcrumbs span[data-level] {
            cursor: pointer;
            padding: 2px 7px;
            border-radius: 999px;
            background-color: var(--bg-elevated-soft);
            border: 1px solid transparent;
        }
        .breadcrumbs span[data-level]:hover {
            border-color: var(--accent);
            color: var(--accent-strong);
        }
        .breadcrumbs span:last-child:not([data-level]) {
            font-weight: 500;
            color: var(--text);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background-color: var(--bg-elevated-soft);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            display: none;
        }
        .progress-fill {
            height: 100%;
            width: 0;
            background-color: var(--accent);
            transition: width 0.25s ease-out;
        }

        /* Lists for modules / units / quizzes */

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 6px;
            margin-bottom: 10px;
        }

        .list-item {
            width: 100%;
            text-align: left;
            padding: 12px 14px;
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            background-color: var(--bg-card);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-family: inherit;      /* match rest of the app */
            color: var(--text);        /* match body text colour */
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25); /* card-style look */
            transition:
                box-shadow 0.18s ease; /* subtle only */
        }

        /* Keep a tiny bit of feedback, but no colour/transform highlight */
        .list-item:hover {
            box-shadow: 0 10px 22px rgba(15, 23, 42, 0.30);
        }

        .list-title {
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
        }

        .list-meta {
            font-size: 12px;
            color: var(--text-soft);
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-family: inherit;
        }

        .helper-text {
            font-size: 12px;
            color: var(--text-soft);
        }

        .error-text {
            font-size: 13px;
            color: var(--danger);
        }

        /* Question view */

        .question-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .question-meta {
            margin: 0 0 10px;
            font-size: 13px;
            color: var(--text-soft);
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .option-btn {
            width: 100%;
            text-align: left;
            padding: 9px 11px;
            border-radius: 14px;
            border: 1px solid var(--option-border);
            background: var(--option-bg);
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            transition:
                background-color 0.18s ease,
                border-color 0.18s ease,
                box-shadow 0.18s ease,
                transform 0.08s ease;
        }
        .option-btn:hover {
            background: var(--option-bg-hover);
            border-color: var(--accent);
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.35);
            transform: translateY(-1px);
        }
        .option-btn.selected {
            border-color: var(--accent-strong);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.45);
        }
        .option-btn.correct {
            border-color: var(--success);
        }
        .option-btn.incorrect {
            border-color: var(--danger);
        }

        .option-label {
            font-weight: 600;
            min-width: 20px;
        }

        .option-text {
            flex: 1;
        }

        .feedback {
            min-height: 20px;
            font-size: 13px;
            color: var(--text-soft);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        .feedback.correct span {
            color: var(--success);
        }
        .feedback.incorrect span.value {
            color: var(--danger);
        }

        .controls {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Results */

        .result-heading {
            font-size: 17px;
            font-weight: 600;
            margin: 0 0 4px;
        }
        .result-score {
            font-size: 14px;
            margin: 0 0 6px;
        }
        .result-detail {
            font-size: 13px;
            margin: 0 0 8px;
            color: var(--text-soft);
        }

        .summary-list {
            margin-top: 8px;
            border-top: 1px solid var(--border-subtle);
            padding-top: 8px;
            max-height: 260px;
            overflow-y: auto;
        }
        .summary-item {
            font-size: 13px;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border-subtle);
        }
        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-question {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .summary-answer {
            margin: 1px 0;
        }
        .summary-answer span.label {
            font-weight: 500;
        }
        .summary-answer.correct span.value {
            color: var(--success);
        }
        .summary-answer.incorrect span.value {
            color: var(--danger);
        }

        /* Sidebar footer link */

        .sidebar-footer {
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .sidebar-footer a.sidebar-footer-link {
            font-size: 13px;
            text-decoration: none;
            color: var(--accent);
        }
        .sidebar-footer a.sidebar-footer-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .card-panel-mcq {
                padding: 16px 14px 18px;
                border-radius: 18px;
            }
            .mcq-header-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }
    </style>

    <!-- Supabase client (for optional login + cloud-stored results) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

</head>
<body class="theme-light">
    <div class="app-shell">
        <!-- Shared header: matches Revision Randomiser -->
        <header class="app-header">
            <div class="header-left">
                <div class="app-logo-circle">Q</div>
                <div class="app-title-group">
                    <h1 class="app-title">Ancient History MCQs</h1>
                    <p class="app-subtitle">Multiple-choice quizzes for active recall</p>
                </div>
            </div>
            <div class="header-right">
                <button
                    id="toggleThemeBtn"
                    class="icon-button"
                    type="button"
                    aria-label="Toggle theme"
                    title="Toggle light / dark theme"
                >
                    ðŸŒ—
                </button>
                <!-- Sidebar burger icon: rightmost -->
                <button
                    id="openSidebarBtn"
                    class="icon-button sidebar-toggle"
                    type="button"
                    aria-label="Quiz options"
                    title="Quiz options"
                >
                    â˜°
                </button>
            </div>
        </header>

        <!-- Main content area -->
        <main class="app-main">
            <section class="card-panel-mcq">
                <div class="mcq-header-row">
                    <div>
                        <h2 class="mcq-title" id="card-title">
                            A Level Ancient History â€“ Multiple Choice Quizzes
                        </h2>
                        <p class="mcq-subtitle">
                            Browse modules and units, then take topic-specific MCQ quizzes.
                        </p>
                    </div>
                    <div class="mcq-pill" id="pill-right"></div>
                </div>

                <div class="breadcrumbs" id="breadcrumbs"></div>

                <div class="progress-bar" id="progress-container">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <div id="quiz-content">
                    <!-- Dynamic content injected by JS -->
                </div>
            </section>
        </main>
    </div>

    <!-- Sidebar: options + account -->
    <aside class="sidebar" id="optionsSidebar">
        <div class="sidebar-inner">
            <div class="sidebar-header">
                <div>
                    <h2>Quiz options</h2>
                    <p class="sidebar-subtitle">
                        Adjust question order and feedback behaviour for this session.
                    </p>
                </div>
                <button
                    type="button"
                    class="icon-button"
                    id="closeSidebarBtn"
                    aria-label="Close options"
                >
                    âœ•
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-header">
                    <p class="sidebar-section-title">Question order</p>
                </div>
                <div class="sidebar-section-controls">
                    <label class="inline-checkbox">
                        <input type="checkbox" id="toggle-shuffle" />
                        <span>Shuffle question order</span>
                    </label>
                    <p class="sidebar-text">
                        When enabled, the questions in each quiz will appear in a random order.
                    </p>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-header">
                    <p class="sidebar-section-title">Feedback mode</p>
                </div>
                <div class="sidebar-section-controls">
                    <label class="inline-checkbox">
                        <input type="checkbox" id="toggle-hide-feedback" />
                        <span>Hide correct answers until the end</span>
                    </label>
                    <p class="sidebar-text">
                        When enabled, you wonâ€™t see which answers are correct as you go.
                        All answers are revealed on the results screen at the end.
                    </p>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-header">
                    <p class="sidebar-section-title">Account</p>
                </div>
                <div class="sidebar-section-controls" id="auth-panel">
                    <!-- Filled by JavaScript: guest mode / login / logout -->
                </div>
            </div>

            <!-- Revision Randomiser link moved to bottom of the sidebar -->
            <div class="sidebar-footer">
                <span class="sidebar-text">Switch app:</span>
                <a
                    href="#"
                    class="sidebar-footer-link"
                    title="Open Revision Randomiser"
                >
                    Revision Randomiser â†—
                </a>
            </div>
        </div>
    </aside>
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <script>
        // ================================
        // Theme toggle (shared behaviour)
        // ================================

        const THEME_KEY = "revision-theme";

        function applyStoredTheme() {
            const stored = localStorage.getItem(THEME_KEY);
            if (!stored || stored === "light") {
                document.body.classList.add("theme-light");
            } else {
                document.body.classList.remove("theme-light");
            }
        }

        function toggleTheme() {
            const isLight = document.body.classList.contains("theme-light");
            if (isLight) {
                document.body.classList.remove("theme-light");
                localStorage.setItem(THEME_KEY, "dark");
            } else {
                document.body.classList.add("theme-light");
                localStorage.setItem(THEME_KEY, "light");
            }
        }

        applyStoredTheme();

        const themeBtn = document.getElementById("toggleThemeBtn");
        if (themeBtn) {
            themeBtn.addEventListener("click", toggleTheme);
        }

        // ================================
        // Sidebar open/close
        // ================================

        const sidebarEl = document.getElementById("optionsSidebar");
        const sidebarBackdropEl = document.getElementById("sidebarBackdrop");
        const openSidebarBtn = document.getElementById("openSidebarBtn");
        const closeSidebarBtn = document.getElementById("closeSidebarBtn");

        function openSidebar() {
            sidebarEl.classList.add("open");
            if (sidebarBackdropEl) sidebarBackdropEl.style.display = "block";
        }

        function closeSidebar() {
            sidebarEl.classList.remove("open");
            if (sidebarBackdropEl) sidebarBackdropEl.style.display = "none";
        }

        if (openSidebarBtn) openSidebarBtn.addEventListener("click", openSidebar);
        if (closeSidebarBtn) closeSidebarBtn.addEventListener("click", closeSidebar);
        if (sidebarBackdropEl) sidebarBackdropEl.addEventListener("click", closeSidebar);

        // ================================
        // Supabase client & auth (optional login + guest mode)
        // ================================
        // Already configured with your project details
        const SUPABASE_URL = "https://bzthteamkdbseartltsv.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6dGh0ZWFta2Ric2VhcnRsdHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MjQ1MTksImV4cCI6MjA3OTMwMDUxOX0.ojZY5BKxa3ERTJsG-pieY64y6iOh3I4iJFPBJ5R1nCk";

        let supabaseClient = null;
        let currentUser = null;

        if (window.supabase && SUPABASE_URL !== "https://YOUR-PROJECT.supabase.co") {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        async function refreshAuthPanel() {
            const panel = document.getElementById("auth-panel");
            if (!panel) return;

            if (!supabaseClient) {
                panel.innerHTML = `
      <div class="sidebar-text">
        Supabase is not configured. Using guest mode only (progress stays on this device).
      </div>
    `;
                return;
            }

            if (!currentUser) {
                // Guest mode: show login + signup as separate actions
                panel.innerHTML = `
      <div class="sidebar-text" style="margin-bottom:6px;">
        <strong>Guest mode:</strong> your scores are saved on this device only.
        Log in or create an account to sync progress across devices.
      </div>
      <input type="email" id="auth-email" placeholder="Email" class="sidebar-input" />
      <input type="password" id="auth-password" placeholder="Password" class="sidebar-input" />
      <div style="display:flex; gap:6px; margin-top:6px; flex-wrap:wrap;">
        <button class="primary-button" id="auth-login-btn">
          Log in
        </button>
        <button class="secondary-button" id="auth-signup-btn">
          Create account
        </button>
      </div>
    `;

                const loginBtn = document.getElementById("auth-login-btn");
                const signupBtn = document.getElementById("auth-signup-btn");

                async function getAuthCredentials() {
                    const emailInput = /** @type {HTMLInputElement} */ (document.getElementById("auth-email"));
                    const passwordInput = /** @type {HTMLInputElement} */ (document.getElementById("auth-password"));
                    const email = (emailInput.value || "").trim();
                    const password = passwordInput.value;

                    if (!email || !password) {
                        alert("Please enter an email and password.");
                        return null;
                    }
                    return { email, password };
                }

                // LOGIN: sign-in only
                if (loginBtn) {
                    loginBtn.addEventListener("click", async () => {
                        if (!supabaseClient) return;
                        const creds = await getAuthCredentials();
                        if (!creds) return;

                        const { email, password } = creds;
                        const { data, error } = await supabaseClient.auth.signInWithPassword({
                            email,
                            password,
                        });

                        if (error) {
                            alert("Login failed: " + error.message);
                            return;
                        }

                        currentUser = data.user;
                        refreshAuthPanel();
                    });
                }

                // SIGNUP: create new account
                if (signupBtn) {
                    signupBtn.addEventListener("click", async () => {
                        if (!supabaseClient) return;
                        const creds = await getAuthCredentials();
                        if (!creds) return;

                        const { email, password } = creds;
                        const { data, error } = await supabaseClient.auth.signUp({
                            email,
                            password,
                        });

                        if (error) {
                            alert("Sign-up error: " + error.message);
                            return;
                        }

                        alert("Account created. If email confirmation is required, check your inbox, then come back and log in.");
                        currentUser = data.user ?? null;
                        refreshAuthPanel();
                    });
                }
            } else {
                // Logged-in UI + optional guest import
                const guestHasData = Object.keys(loadGuestResults()).length > 0;
                const showImportPrompt = guestHasData && !hasGuestBeenImported();

                panel.innerHTML = `
      <div class="sidebar-text">
        Logged in as <strong>${currentUser.email}</strong><br />
        Your quiz results are synced via Supabase.
      </div>

      ${
        showImportPrompt
          ? `<div class="sidebar-text" style="margin-top:6px;">
               We found quiz progress saved in guest mode on this device.
               You can import it into your account so it syncs across devices.
             </div>
             <button class="primary-button" id="import-guest-btn" style="margin-top:6px;">
               Import guest progress
             </button>`
          : ""
      }

      <button class="secondary-button" id="auth-logout-btn" style="margin-top:8px;">
        Log out
      </button>
    `;

                const logoutBtn = document.getElementById("auth-logout-btn");
                if (logoutBtn) {
                    logoutBtn.addEventListener("click", async () => {
                        await supabaseClient.auth.signOut();
                        currentUser = null;
                        refreshAuthPanel();
                    });
                }

                const importBtn = document.getElementById("import-guest-btn");
                if (importBtn) {
                    importBtn.addEventListener("click", async () => {
                        await importGuestResultsToSupabase();
                        refreshAuthPanel();
                    });
                }
            }
        }

        async function initAuth() {
            if (!supabaseClient) {
                currentUser = null;
                refreshAuthPanel();
                return;
            }

            const { data } = await supabaseClient.auth.getUser();
            currentUser = data.user ?? null;
            refreshAuthPanel();

            supabaseClient.auth.onAuthStateChange((_event, session) => {
                currentUser = session?.user ?? null;
                refreshAuthPanel();
            });
        }

        // ================================
        // Quiz results: guest (localStorage) + Supabase
        // ================================
        function getQuizIdFromMeta(quizMeta) {
            return quizMeta && quizMeta.id ? quizMeta.id : quizMeta.path;
        }

        const GUEST_RESULTS_KEY = "mcqGuestResults";
        const GUEST_IMPORTED_KEY = "mcqGuestResultsImported";

        function hasGuestBeenImported() {
            return localStorage.getItem(GUEST_IMPORTED_KEY) === "true";
        }

        function markGuestImported() {
            localStorage.setItem(GUEST_IMPORTED_KEY, "true");
        }

        function loadGuestResults() {
            try {
                const raw = localStorage.getItem(GUEST_RESULTS_KEY);
                if (!raw) return {};
                return JSON.parse(raw);
            } catch {
                return {};
            }
        }

        function saveGuestResults(all) {
            try {
                localStorage.setItem(GUEST_RESULTS_KEY, JSON.stringify(all));
            } catch (e) {
                console.warn("Failed to save guest results", e);
            }
        }

        function updateGuestQuizResults(quizMeta, score, total) {
            const quizId = getQuizIdFromMeta(quizMeta);
            const all = loadGuestResults();
            const prev = all[quizId];

            const percent = total > 0 ? Math.round((score / total) * 100) : 0;
            const attempts = prev ? prev.attempts + 1 : 1;

            const isBest =
                !prev || percent > prev.bestPercent || (percent === prev.bestPercent && score > prev.bestScore);

            const updated = {
                attempts,
                lastScore: score,
                lastTotal: total,
                lastPercent: percent,
                lastCompletedAt: new Date().toISOString(),
                bestScore: isBest ? score : (prev?.bestScore ?? score),
                bestTotal: isBest ? total : (prev?.bestTotal ?? total),
                bestPercent: isBest ? percent : (prev?.bestPercent ?? percent),
            };

            all[quizId] = updated;
            saveGuestResults(all);
            return updated;
        }

        function getGuestQuizResults(quizMeta) {
            const quizId = getQuizIdFromMeta(quizMeta);
            const all = loadGuestResults();
            return all[quizId] || null;
        }

        async function saveAttemptToSupabase(quizMeta, score, total) {
            if (!supabaseClient || !currentUser) return null;

            const quizId = getQuizIdFromMeta(quizMeta);
            const percent = total > 0 ? Math.round((score / total) * 100) : 0;

            const { error } = await supabaseClient.from("quiz_attempts").insert({
                user_id: currentUser.id,
                quiz_id: quizId,
                score,
                total,
                percent,
            });

            if (error) {
                console.error("Failed to save quiz attempt:", error.message);
                return null;
            }

            // After insert, fetch attempts to compute best stats
            const { data, error: statsError } = await supabaseClient
                .from("quiz_attempts")
                .select("score, total, percent")
                .eq("user_id", currentUser.id)
                .eq("quiz_id", quizId);

            if (statsError || !data) {
                console.error("Failed to fetch updated stats:", statsError?.message);
                return null;
            }

            const attempts = data.length;
            let bestScore = -1;
            let bestTotal = 0;
            let bestPercent = -1;

            for (const row of data) {
                if (row.percent > bestPercent || (row.percent === bestPercent && row.score > bestScore)) {
                    bestPercent = row.percent;
                    bestScore = row.score;
                    bestTotal = row.total;
                }
            }

            return {
                attempts,
                bestScore,
                bestTotal,
                bestPercent,
            };
        }

        // Import guest results (best scores) into Supabase for the logged-in user
        async function importGuestResultsToSupabase() {
            if (!supabaseClient || !currentUser) return;

            const all = loadGuestResults();
            const entries = Object.entries(all);
            if (entries.length === 0) {
                alert("No guest progress found on this device.");
                return;
            }

            const rows = [];

            for (const [quizId, stats] of entries) {
                if (!stats || stats.bestScore == null || stats.bestTotal == null) continue;

                rows.push({
                    user_id: currentUser.id,
                    quiz_id: quizId,
                    score: stats.bestScore,
                    total: stats.bestTotal,
                    percent: stats.bestPercent ?? Math.round((stats.bestScore / stats.bestTotal) * 100),
                });
            }

            if (rows.length === 0) {
                alert("No usable guest progress found to import.");
                return;
            }

            const { error } = await supabaseClient.from("quiz_attempts").insert(rows);

            if (error) {
                console.error("Failed to import guest results:", error.message);
                alert("Sorry, something went wrong while importing your guest progress.");
                return;
            }

            markGuestImported();
            alert("Guest progress imported into your account! Your stats will now sync across devices.");
        }

        async function fetchQuizStatsFromSupabase(quizMeta) {
            if (!supabaseClient || !currentUser) return null;

            const quizId = getQuizIdFromMeta(quizMeta);

            const { data, error } = await supabaseClient
                .from("quiz_attempts")
                .select("score, total, percent")
                .eq("user_id", currentUser.id)
                .eq("quiz_id", quizId);

            if (error || !data) {
                console.error("Failed to fetch stats:", error?.message);
                return null;
            }

            if (data.length === 0) {
                return {
                    attempts: 0,
                    bestScore: null,
                    bestTotal: null,
                    bestPercent: null,
                };
            }

            const attempts = data.length;
            let bestScore = -1;
            let bestTotal = 0;
            let bestPercent = -1;

            for (const row of data) {
                if (row.percent > bestPercent || (row.percent === bestPercent && row.score > bestScore)) {
                    bestPercent = row.percent;
                    bestScore = row.score;
                    bestTotal = row.total;
                }
            }

            return {
                attempts,
                bestScore,
                bestTotal,
                bestPercent,
            };
        }

        async function saveAttempt(quizMeta, score, total) {
            if (supabaseClient && currentUser) {
                return await saveAttemptToSupabase(quizMeta, score, total);
            } else {
                return updateGuestQuizResults(quizMeta, score, total);
            }
        }

        async function getQuizStats(quizMeta) {
            if (supabaseClient && currentUser) {
                return await fetchQuizStatsFromSupabase(quizMeta);
            } else {
                return getGuestQuizResults(quizMeta);
            }
        }

        // ================================
        // MCQ APP LOGIC
        // ================================

        let modules = [];
        let currentModule = null;
        let currentUnit = null;
        let currentQuizMeta = null;
        let currentQuizData = null;

        let currentQuestionIndex = 0; // position in order (0..n-1)
        let selectedOptionIndex = null;
        let score = 0;
        const answers = [];

        // State for toggles
        let shuffleQuestionsEnabled = false;
        let hideFeedbackEnabled = false;
        let questionOrder = [];      // array of original question indices
        let currentOptionOrder = []; // shuffled option indices for the current question

        const quizContentEl = document.getElementById("quiz-content");
        const cardTitleEl = document.getElementById("card-title");
        const pillRightEl = document.getElementById("pill-right");
        const progressContainerEl = document.getElementById("progress-container");
        const progressFillEl = document.getElementById("progress-fill");
        const breadcrumbsEl = document.getElementById("breadcrumbs");

        // Shuffle helper (Fisherâ€“Yates)
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        async function loadModules() {
            try {
                const res = await fetch("modules.json");
                if (!res.ok) throw new Error("Failed to load modules.json");
                modules = await res.json();
                renderModuleList();
            } catch (err) {
                console.error(err);
                pillRightEl.textContent = "Error loading modules";
                progressContainerEl.style.display = "none";
                breadcrumbsEl.textContent = "";
                quizContentEl.innerHTML = `
          <p class="error-text">Could not load <code>modules.json</code>.</p>
          <p class="helper-text">
            Make sure <strong>modules.json</strong> is in the same folder as
            <strong>index.html</strong> and that you're running this via a local web
            server (not opening the file directly).
          </p>
        `;
            }
        }

        function setBreadcrumbs(level) {
            const bits = [];
            bits.push(`<span data-level="modules">Modules</span>`);

            if (currentModule && level !== "modules") {
                bits.push("â€º");
                bits.push(`<span data-level="units">${currentModule.name}</span>`);
            }
            if (currentUnit && (level === "quizzes" || level === "quiz")) {
                bits.push("â€º");
                bits.push(`<span data-level="quizzes">${currentUnit.name}</span>`);
            }
            if (currentQuizMeta && level === "quiz") {
                bits.push("â€º");
                bits.push(`<span>${currentQuizMeta.title}</span>`);
            }

            breadcrumbsEl.innerHTML = bits.join(" ");

            Array.from(
                breadcrumbsEl.querySelectorAll("span[data-level]")
            ).forEach((el) => {
                el.addEventListener("click", () => {
                    const lvl = el.getAttribute("data-level");
                    if (lvl === "modules") {
                        renderModuleList();
                    } else if (lvl === "units") {
                        renderUnitList(currentModule.id);
                    } else if (lvl === "quizzes") {
                        renderQuizList(currentUnit.id);
                    }
                });
            });
        }

        function renderModuleList() {
            currentModule = null;
            currentUnit = null;
            currentQuizMeta = null;
            currentQuizData = null;
            questionOrder = [];

            cardTitleEl.textContent =
                "A Level Ancient History â€“ Multiple Choice Quizzes";
            progressContainerEl.style.display = "none";
            progressFillEl.style.width = "0";
            setBreadcrumbs("modules");

            if (!modules || !modules.length) {
                pillRightEl.textContent = "0 modules";
                quizContentEl.innerHTML = `
          <p>No modules found in <code>modules.json</code>.</p>
          <p class="helper-text">
            Add modules, units and quizzes to the JSON file to see them listed here.
          </p>
        `;
                return;
            }

            pillRightEl.textContent =
                modules.length === 1 ? "1 module" : `${modules.length} modules`;

            const html = `
        <div class="list">
          ${modules
              .map(
                  (m) => `
            <button class="list-item" data-id="${m.id}">
              <div class="list-title">${m.name}</div>
              <div class="list-meta">
                <span>${m.units?.length || 0} unit${
                      (m.units?.length || 0) !== 1 ? "s" : ""
                  }</span>
                ${m.description ? `<span>â€¢ ${m.description}</span>` : ""}
              </div>
            </button>
          `
              )
              .join("")}
        </div>
        <p class="helper-text">
          Select a module to view its units and quizzes. Edit
          <strong>modules.json</strong> to organise your content.
        </p>
      `;

            quizContentEl.innerHTML = html;

            document.querySelectorAll(".list-item").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-id");
                    renderUnitList(id);
                });
            });
        }

        function renderUnitList(moduleId) {
            const mod = modules.find((m) => m.id === moduleId);
            if (!mod) return;

            currentModule = mod;
            currentUnit = null;
            currentQuizMeta = null;
            currentQuizData = null;
            questionOrder = [];

            cardTitleEl.textContent = mod.name;
            progressContainerEl.style.display = "none";
            progressFillEl.style.width = "0";
            setBreadcrumbs("units");

            const units = mod.units || [];
            pillRightEl.textContent =
                units.length === 1 ? "1 unit" : `${units.length} units`;

            if (!units.length) {
                quizContentEl.innerHTML = `
          <p>No units found for this module.</p>
          <div class="controls" style="justify-content:flex-start;">
            <button class="secondary-button" id="back-modules">Back to modules</button>
          </div>
        `;
                document
                    .getElementById("back-modules")
                    .addEventListener("click", () => renderModuleList());
                return;
            }

            const html = `
        <div class="list">
          ${units
              .map(
                  (u) => `
            <button class="list-item" data-id="${u.id}">
              <div class="list-title">${u.name}</div>
              <div class="list-meta">
                <span>${u.quizzes?.length || 0} quiz${
                      (u.quizzes?.length || 0) !== 1 ? "zes" : ""
                  }</span>
                ${u.description ? `<span>â€¢ ${u.description}</span>` : ""}
              </div>
            </button>
          `
              )
              .join("")}
        </div>
        <div class="controls" style="justify-content:flex-start;">
          <button class="secondary-button" id="back-modules">Back to modules</button>
        </div>
      `;

            quizContentEl.innerHTML = html;

            document.querySelectorAll(".list-item").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-id");
                    renderQuizList(id);
                });
            });

            document
                .getElementById("back-modules")
                .addEventListener("click", () => renderModuleList());
        }

        function renderQuizList(unitId) {
            if (!currentModule) return;
            const unit = (currentModule.units || []).find((u) => u.id === unitId);
            if (!unit) return;

            currentUnit = unit;
            currentQuizMeta = null;
            currentQuizData = null;
            questionOrder = [];

            cardTitleEl.textContent = unit.name;
            progressContainerEl.style.display = "none";
            progressFillEl.style.width = "0";
            setBreadcrumbs("quizzes");

            const quizzes = unit.quizzes || [];
            pillRightEl.textContent =
                quizzes.length === 1 ? "1 quiz" : `${quizzes.length} quizzes`;

            if (!quizzes.length) {
                quizContentEl.innerHTML = `
          <p>No quizzes found for this unit.</p>
          <div class="controls" style="justify-content:flex-start;">
            <button class="secondary-button" id="back-units">Back to units</button>
          </div>
        `;
                document
                    .getElementById("back-units")
                    .addEventListener("click", () => renderUnitList(currentModule.id));
                return;
            }

            const html = `
        <div class="list">
          ${quizzes
              .map(
                  (q) => `
            <button class="list-item" data-id="${q.id}">
              <div class="list-title">${q.title}</div>
              <div class="list-meta" data-stats-for="${q.id}">
                <span>${currentUser ? "Loading statsâ€¦" : "Guest: progress saved on this device"}</span>
              </div>
            </button>
          `
              )
              .join("")}
        </div>
        <div class="controls" style="justify-content:flex-start;">
          <button class="secondary-button" id="back-units">Back to units</button>
        </div>
      `;

            quizContentEl.innerHTML = html;

            document.querySelectorAll(".list-item").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-id");
                    const meta = quizzes.find((q) => q.id === id);
                    if (meta) startQuiz(meta);
                });
            });

            document
                .getElementById("back-units")
                .addEventListener("click", () => renderUnitList(currentModule.id));

            // Populate stats per quiz (attempts, best score)
            quizzes.forEach(async (q) => {
                const metaEl = document.querySelector(`.list-meta[data-stats-for="${q.id}"]`);
                if (!metaEl) return;

                const stats = await getQuizStats(q);
                if (!stats || !stats.attempts) {
                    metaEl.innerHTML = currentUser
                        ? `<span>Not attempted yet</span>`
                        : `<span>Guest: not attempted yet</span>`;
                } else {
                    metaEl.innerHTML = `
        <span>Attempts: ${stats.attempts}</span>
        <span>â€¢</span>
        <span>Best: ${stats.bestScore}/${stats.bestTotal} (${stats.bestPercent}%)</span>
      `;
                }
            });
        }

        async function startQuiz(quizMeta) {
            currentQuizMeta = quizMeta;
            currentQuizData = null;
            currentQuestionIndex = 0;
            selectedOptionIndex = null;
            score = 0;
            answers.length = 0;
            questionOrder = [];

            setBreadcrumbs("quiz");
            pillRightEl.textContent = "Loading quizâ€¦";
            progressContainerEl.style.display = "none";
            progressFillEl.style.width = "0";

            quizContentEl.innerHTML = `
        <p>Loading quiz <strong>${quizMeta.title}</strong>â€¦</p>
        <p class="helper-text">File: <code>${quizMeta.path}</code></p>
      `;

            try {
                const res = await fetch(quizMeta.path);
                if (!res.ok) throw new Error("Failed to load quiz JSON");
                const data = await res.json();
                currentQuizData = data;

                const questions = currentQuizData.questions || [];
                questionOrder = questions.map((_, i) => i);
                if (shuffleQuestionsEnabled) {
                    shuffleArray(questionOrder);
                }

                cardTitleEl.textContent = data.title || quizMeta.title;
                progressContainerEl.style.display = "block";
                renderQuestion();
            } catch (err) {
                console.error(err);
                pillRightEl.textContent = "Error loading quiz";
                progressContainerEl.style.display = "none";
                quizContentEl.innerHTML = `
          <p class="error-text">Could not load quiz file <code>${quizMeta.path}</code>.</p>
          <div class="controls" style="justify-content:flex-start;">
            <button class="secondary-button" id="back-quizzes">Back to quizzes</button>
          </div>
        `;
                document
                    .getElementById("back-quizzes")
                    .addEventListener("click", () => renderQuizList(currentUnit.id));
            }
        }

        // ===== Render a question (with SHUFFLED OPTIONS) =====
        function renderQuestion() {
            const questions = currentQuizData.questions || [];

            // Which original question are we on (handles question-order shuffle)
            const orderIndex = questionOrder[currentQuestionIndex] ?? currentQuestionIndex;
            const q = questions[orderIndex];
            if (!q) return;

            selectedOptionIndex = null;

            // Build and shuffle option order for this question
            currentOptionOrder = q.options.map((_, i) => i); // [0,1,2,...]
            shuffleArray(currentOptionOrder);

            setBreadcrumbs("quiz");
            pillRightEl.textContent = `Question ${
                currentQuestionIndex + 1
            } of ${questions.length}`;

            const progressPercent = (currentQuestionIndex / questions.length) * 100;
            progressFillEl.style.width = `${progressPercent}%`;

            const optionLetters = ["A", "B", "C", "D", "E", "F", "G", "H"];

            // Build buttons in shuffled order; data-index stores ORIGINAL option index
            const optionsHtml = currentOptionOrder
                .map((optIdx, displayIdx) => {
                    const label = optionLetters[displayIdx] ?? "";
                    const text = q.options[optIdx];
                    return `
          <button class="option-btn" data-index="${optIdx}">
            <span class="option-label">${label}.</span>
            <span class="option-text">${text}</span>
          </button>
        `;
                })
                .join("");

            quizContentEl.innerHTML = `
        <div class="question-text">${q.question}</div>
        <p class="question-meta">${
            currentQuizData.description || "Choose one answer."
        }</p>
        <div class="options">
          ${optionsHtml}
        </div>
        <div class="feedback" id="feedback"></div>
        <div class="controls">
          <button class="secondary-button" id="back-to-quizzes">Back to quizzes</button>
          <button class="secondary-button" id="skip-btn">Skip</button>
          <button class="primary-button" id="next-btn" disabled>
            Next â†’
          </button>
        </div>
      `;

            document
                .querySelectorAll(".option-btn")
                .forEach((btn) => btn.addEventListener("click", onOptionClick));
            document.getElementById("next-btn").addEventListener("click", onNext);
            document.getElementById("skip-btn").addEventListener("click", onSkip);
            document
                .getElementById("back-to-quizzes")
                .addEventListener("click", () => renderQuizList(currentUnit.id));
        }

        function onOptionClick(e) {
            const btn = e.currentTarget;
            const index = Number(btn.getAttribute("data-index")); // ORIGINAL option index
            selectedOptionIndex = index;

            document.querySelectorAll(".option-btn").forEach((b) => {
                b.classList.remove("selected");
            });
            btn.classList.add("selected");

            document.getElementById("next-btn").disabled = false;
            const feedbackEl = document.getElementById("feedback");
            feedbackEl.textContent = "Answer selected.";
            feedbackEl.className = "feedback";
        }

        function lockOptionsAndShowFeedback(isCorrect, correctIndex) {
            const feedbackEl = document.getElementById("feedback");
            feedbackEl.className =
                "feedback " + (isCorrect ? "correct" : "incorrect");

            document.querySelectorAll(".option-btn").forEach((btn) => {
                const idx = Number(btn.getAttribute("data-index"));
                btn.disabled = true;
                btn.classList.remove("selected");

                if (idx === correctIndex) {
                    btn.classList.add("correct");
                } else if (idx === selectedOptionIndex && !isCorrect) {
                    btn.classList.add("incorrect");
                }
            });

            if (isCorrect) {
                feedbackEl.innerHTML = `<span>Correct!</span> Nice job.`;
            } else if (selectedOptionIndex === null) {
                feedbackEl.innerHTML = `<span>Skipped.</span> The correct answer is highlighted.`;
            } else {
                feedbackEl.innerHTML = `<span>Incorrect.</span> The correct answer is highlighted.`;
            }
        }

        function onNext() {
            const questions = currentQuizData.questions;
            const orderIndex = questionOrder[currentQuestionIndex] ?? currentQuestionIndex;
            const q = questions[orderIndex];
            const correctIndex = q.correctIndex;
            const isCorrect = selectedOptionIndex === correctIndex;

            if (selectedOptionIndex !== null && isCorrect) {
                score++;
            }

            answers.push({
                questionIndex: orderIndex,
                selected: selectedOptionIndex,
                correctIndex,
                isCorrect,
            });

            if (hideFeedbackEnabled) {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion();
                } else {
                    renderResult();
                }
            } else {
                lockOptionsAndShowFeedback(isCorrect, correctIndex);
                setTimeout(() => {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < questions.length) {
                        renderQuestion();
                    } else {
                        renderResult();
                    }
                }, 650);
            }
        }

        function onSkip() {
            const questions = currentQuizData.questions;
            const orderIndex = questionOrder[currentQuestionIndex] ?? currentQuestionIndex;
            const q = questions[orderIndex];
            const correctIndex = q.correctIndex;

            answers.push({
                questionIndex: orderIndex,
                selected: null,
                correctIndex,
                isCorrect: false,
            });

            if (hideFeedbackEnabled) {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion();
                } else {
                    renderResult();
                }
            } else {
                lockOptionsAndShowFeedback(false, correctIndex);
                setTimeout(() => {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < questions.length) {
                        renderQuestion();
                    } else {
                        renderResult();
                    }
                }, 650);
            }
        }

        async function renderResult() {
            const questions = currentQuizData.questions;
            const total = questions.length;
            const percent = Math.round((score / total) * 100);

            // Save attempt (guest or logged-in) and get updated stats
            const stats = await saveAttempt(currentQuizMeta, score, total);

            progressFillEl.style.width = "100%";
            pillRightEl.textContent = "Quiz complete";
            setBreadcrumbs("quiz");

            const summaryItemsHtml = answers
                .map((ans, i) => {
                    const q = questions[ans.questionIndex];
                    const qNumber = i + 1;
                    const userAnswerText =
                        ans.selected === null ? "No answer" : q.options[ans.selected];
                    const correctAnswerText = q.options[ans.correctIndex];
                    const userClass = ans.isCorrect ? "correct" : "incorrect";

                    return `
            <div class="summary-item">
              <div class="summary-question">
                ${qNumber}. ${q.question}
              </div>
              <div class="summary-answer ${userClass}">
                <span class="label">Your answer:</span>
                <span class="value"> ${userAnswerText}</span>
              </div>
              <div class="summary-answer">
                <span class="label">Correct answer:</span>
                <span class="value"> ${correctAnswerText}</span>
              </div>
            </div>
          `;
                })
                .join("");

            let statsLine = "";
            if (stats) {
                statsLine = "Attempts: <strong>" + stats.attempts + "</strong>";
                if (stats.bestScore != null) {
                    statsLine += " â€¢ Best: <strong>" +
                        stats.bestScore + "/" + stats.bestTotal +
                        " (" + stats.bestPercent + "%)</strong>";
                }
            }

            quizContentEl.innerHTML = `
        <div class="result-heading">
          Your results for "${currentQuizData.title || currentQuizMeta.title}"
        </div>
        <p class="result-score">
          You scored <strong>${score}</strong> out of <strong>${total}</strong> (${percent}%)
        </p>
        ${
          statsLine
            ? `<p class="result-detail">${statsLine}</p>`
            : `<p class="result-detail">
          Review your answers below, or go back to choose another quiz in this unit.
        </p>`
        }

        <div class="controls" style="margin-bottom: 6px;">
          <button class="secondary-button" id="back-quizzes">Back to quizzes</button>
          <button class="primary-button" id="restart-btn">Retake this quiz</button>
        </div>

        <div class="summary-list">
          ${summaryItemsHtml}
        </div>
      `;

            document.getElementById("restart-btn").addEventListener("click", () => {
                startQuiz(currentQuizMeta);
            });

            document
                .getElementById("back-quizzes")
                .addEventListener("click", () => {
                    renderQuizList(currentUnit.id);
                });
        }

        // Hook up sidebar toggles
        const shuffleToggleEl = document.getElementById("toggle-shuffle");
        const hideFeedbackToggleEl = document.getElementById("toggle-hide-feedback");

        if (shuffleToggleEl) {
            shuffleToggleEl.addEventListener("change", (e) => {
                shuffleQuestionsEnabled = e.target.checked;
            });
        }

        if (hideFeedbackToggleEl) {
            hideFeedbackToggleEl.addEventListener("change", (e) => {
                hideFeedbackEnabled = e.target.checked;
            });
        }

        loadModules();
        initAuth();
    </script>
</body>
</html>
